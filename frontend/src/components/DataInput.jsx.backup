import { useState } from 'react';
import { FileJson, Play, AlertCircle, CheckCircle2, Wand2 } from 'lucide-react';
import LoadingSpinner from './LoadingSpinner';
import { processGemJSON } from '../utils/jsonCleaner';

export default function DataInput({ onAnalyze }) {
  const [trialAJson, setTrialAJson] = useState('');
  const [trialBJson, setTrialBJson] = useState('');
  const [validationA, setValidationA] = useState(null);
  const [validationB, setValidationB] = useState(null);
  const [isValidating, setIsValidating] = useState(false);

  const validateJSON = (text, setValidation) => {
    if (!text.trim()) {
      setValidation(null);
      return null;
    }

    try {
      // Try to process as Gem JSON (with citation cleaning)
      const parsed = processGemJSON(text);
      setValidation({ valid: true, data: parsed, cleaned: true });
      return parsed;
    } catch (error) {
      // If processing fails, try regular JSON parse
      try {
        const parsed = JSON.parse(text);
        setValidation({ valid: true, data: parsed, cleaned: false });
        return parsed;
      } catch (parseError) {
        setValidation({ valid: false, error: error.message });
        return null;
      }
    }
  };

  const handleTrialAChange = (e) => {
    const text = e.target.value;
    setTrialAJson(text);
    validateJSON(text, setValidationA);
  };

  const handleTrialBChange = (e) => {
    const text = e.target.value;
    setTrialBJson(text);
    validateJSON(text, setValidationB);
  };

  const handleAnalyze = () => {
    if (validationA?.valid && validationB?.valid) {
      onAnalyze(validationA.data, validationB.data);
    }
  };

  const isReadyToAnalyze = validationA?.valid && validationB?.valid;

  const loadExample = () => {
    const exampleA = {
      trial_metadata: {
        trial_name: "KEYNOTE-189",
        nct_id: "NCT02578680",
        publication_year: 2018,
        indication: "Non-squamous NSCLC",
        phase: "Phase III"
      },
      arms_description: {
        experimental_arm: "Pembrolizumab + Chemotherapy",
        control_arm: "Placebo + Chemotherapy",
        n_experimental: 410,
        n_control: 206
      },
      baseline_characteristics: {
        median_age_exp: 64,
        median_age_ctrl: 63,
        sex_male_percentage_exp: 60,
        sex_male_percentage_ctrl: 62,
        ecog_0_percentage_exp: 35,
        ecog_0_percentage_ctrl: 33
      },
      efficacy_outcomes: {
        primary_endpoint_data: {
          endpoint_name: "Overall Survival",
          hazard_ratio: 0.49,
          ci_lower_95: 0.38,
          ci_upper_95: 0.64,
          p_value: 0.00001,
          median_exp_months: 22.0,
          median_ctrl_months: 10.7
        }
      },
      safety_toxicity: {
        any_grade_3_5_ae_rate_exp: 67.2,
        any_grade_3_5_ae_rate_ctrl: 65.8,
        discontinuation_rate_exp: 13.4,
        discontinuation_rate_ctrl: 10.2
      }
    };

    const exampleB = {
      trial_metadata: {
        trial_name: "CheckMate-9LA",
        nct_id: "NCT03215706",
        publication_year: 2021,
        indication: "Metastatic NSCLC",
        phase: "Phase III"
      },
      arms_description: {
        experimental_arm: "Nivolumab + Ipilimumab + Chemotherapy",
        control_arm: "Placebo + Chemotherapy",
        n_experimental: 361,
        n_control: 358
      },
      baseline_characteristics: {
        median_age_exp: 65,
        median_age_ctrl: 65,
        sex_male_percentage_exp: 58,
        sex_male_percentage_ctrl: 60,
        ecog_0_percentage_exp: 33,
        ecog_0_percentage_ctrl: 32
      },
      efficacy_outcomes: {
        primary_endpoint_data: {
          endpoint_name: "Overall Survival",
          hazard_ratio: 0.66,
          ci_lower_95: 0.55,
          ci_upper_95: 0.80,
          p_value: 0.00001,
          median_exp_months: 15.8,
          median_ctrl_months: 11.0
        }
      },
      safety_toxicity: {
        any_grade_3_5_ae_rate_exp: 47.0,
        any_grade_3_5_ae_rate_ctrl: 38.0,
        discontinuation_rate_exp: 18.0,
        discontinuation_rate_ctrl: 9.0
      }
    };

    setTrialAJson(JSON.stringify(exampleA, null, 2));
    setTrialBJson(JSON.stringify(exampleB, null, 2));
    validateJSON(JSON.stringify(exampleA, null, 2), setValidationA);
    validateJSON(JSON.stringify(exampleB, null, 2), setValidationB);
  };

  return (
    <div className="animate-fade-in">
      {/* Instructions Card */}
      <div className="card p-6 mb-8">
        <div className="flex items-start space-x-3">
          <AlertCircle className="w-5 h-5 text-primary-600 mt-0.5 flex-shrink-0" />
          <div>
            <h3 className="font-semibold text-gray-900 mb-2">Instructions</h3>
            <ul className="text-sm text-gray-600 space-y-1 list-disc list-inside">
              <li>Paste JSON data from clinical trials (including from Google Gem API)</li>
              <li>Citation tags like [cite_start] and [cite: XX] will be automatically cleaned</li>
              <li>Both trials must compare their experimental arm to a common comparator (e.g., placebo)</li>
              <li>JSON will be validated and normalized automatically as you type</li>
              <li>Click "Load Example" to see the required format</li>
            </ul>
          </div>
        </div>
      </div>

      {/* Input Cards */}
      <div className="grid md:grid-cols-2 gap-6 mb-8">
        {/* Trial A */}
        <div className="card p-6">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center space-x-2">
              <FileJson className="w-5 h-5 text-primary-600" />
              <h3 className="font-semibold text-gray-900">Trial A</h3>
            </div>
            {validationA && (
              validationA.valid ? (
                <CheckCircle2 className="w-5 h-5 text-green-500" />
              ) : (
                <AlertCircle className="w-5 h-5 text-red-500" />
              )
            )}
          </div>

          <textarea
            className="textarea font-mono text-sm"
            rows="16"
            placeholder='Paste Trial A JSON here...'
            value={trialAJson}
            onChange={handleTrialAChange}
          />

          {validationA && !validationA.valid && (
            <p className="mt-2 text-xs text-red-600">
              Invalid JSON: {validationA.error}
            </p>
          )}

          {validationA?.valid && (
            <div className="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
              <div className="flex items-center justify-between mb-1">
                <p className="text-xs font-semibold text-green-800">Trial Info:</p>
                {validationA.cleaned && (
                  <span className="flex items-center text-xs text-green-600">
                    <Wand2 className="w-3 h-3 mr-1" />
                    Auto-cleaned
                  </span>
                )}
              </div>
              <p className="text-xs text-green-700">
                {validationA.data.trial_metadata?.trial_name || 'Unknown Trial'}
              </p>
              <p className="text-xs text-green-700">
                {validationA.data.arms_description?.experimental_arm || 'Unknown Arm'}
              </p>
            </div>
          )}
        </div>

        {/* Trial B */}
        <div className="card p-6">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center space-x-2">
              <FileJson className="w-5 h-5 text-secondary-600" />
              <h3 className="font-semibold text-gray-900">Trial B</h3>
            </div>
            {validationB && (
              validationB.valid ? (
                <CheckCircle2 className="w-5 h-5 text-green-500" />
              ) : (
                <AlertCircle className="w-5 h-5 text-red-500" />
              )
            )}
          </div>

          <textarea
            className="textarea font-mono text-sm"
            rows="16"
            placeholder='Paste Trial B JSON here...'
            value={trialBJson}
            onChange={handleTrialBChange}
          />

          {validationB && !validationB.valid && (
            <p className="mt-2 text-xs text-red-600">
              Invalid JSON: {validationB.error}
            </p>
          )}

          {validationB?.valid && (
            <div className="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
              <div className="flex items-center justify-between mb-1">
                <p className="text-xs font-semibold text-green-800">Trial Info:</p>
                {validationB.cleaned && (
                  <span className="flex items-center text-xs text-green-600">
                    <Wand2 className="w-3 h-3 mr-1" />
                    Auto-cleaned
                  </span>
                )}
              </div>
              <p className="text-xs text-green-700">
                {validationB.data.trial_metadata?.trial_name || 'Unknown Trial'}
              </p>
              <p className="text-xs text-green-700">
                {validationB.data.arms_description?.experimental_arm || 'Unknown Arm'}
              </p>
            </div>
          )}
        </div>
      </div>

      {/* Action Buttons */}
      <div className="flex items-center justify-center space-x-4">
        <button
          onClick={loadExample}
          className="btn btn-outline"
        >
          Load Example Data
        </button>

        <button
          onClick={handleAnalyze}
          disabled={!isReadyToAnalyze || isValidating}
          className={`btn btn-primary flex items-center space-x-2 ${
            !isReadyToAnalyze ? 'opacity-50 cursor-not-allowed' : ''
          }`}
        >
          {isValidating ? (
            <>
              <LoadingSpinner size="small" />
              <span>Validating...</span>
            </>
          ) : (
            <>
              <Play className="w-4 h-4" />
              <span>Run Analysis</span>
            </>
          )}
        </button>
      </div>
    </div>
  );
}
